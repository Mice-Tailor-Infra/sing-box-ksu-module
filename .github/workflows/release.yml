name: Build and Release Module

on:
  workflow_dispatch:
  repository_dispatch:
    types: [config_update] # æ¥æ”¶æ¥è‡ªæ¨¡æ¿ä»“çš„ä¿¡å·
  push:
    branches: ["main"]
    paths-ignore:
      - "README.md"
      - ".gitignore"
      - "update.json" # [é˜²çº¿1] å¿½ç•¥ update.json çš„å˜æ›´è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Material
        run: |
          # 1. æŠ“å–ç¨³å®šäºŒè¿›åˆ¶
          SB_VER=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases | \
            jq -r 'map(select(.tag_name | contains("alpha") | not) | select(.tag_name | contains("dev") | not)) | .[0].tag_name')

          echo "SB_VER=$SB_VER" >> $GITHUB_ENV

          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases/tags/$SB_VER | \
            jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')

          curl -L -o sing-box-android.tar.gz "$DOWNLOAD_URL"

          # [å…³é”®ä¿®æ”¹] ä¸è¦è§£å‹è¦†ç›–æ•´ä¸ª binï¼Œè€Œæ˜¯åªæå– sing-box
          # tar -xzf ... -C bin/ ä¼šæŠŠ bin é‡Œçš„ sbc/envsubst è¦†ç›–æ‰ï¼ˆå¦‚æœ tar åŒ…é‡Œä¹Ÿæœ‰åŒåç›®å½•ï¼‰
          # è™½ç„¶ä½ çš„ tar åŒ…é‡Œåªæœ‰ sing-boxï¼Œä½†æœ€ç¨³å¦¥çš„æ˜¯è§£å‹åˆ°ä¸´æ—¶ç›®å½•å† mv
          mkdir -p temp_bin
          tar -xzf sing-box-android.tar.gz -C temp_bin/

          # ç§»åŠ¨å¹¶å¤„ç†åŒåå†²çª (Mice ä¸“å±é€»è¾‘)
          if [ -f "temp_bin/bin/sing-box" ]; then
              mv temp_bin/bin/sing-box bin/sing-box
          elif [ -f "temp_bin/sing-box" ]; then
              mv temp_bin/sing-box bin/sing-box
          else
              # å…œåº•ï¼šå¤„ç†å¯èƒ½çš„å¸¦ç‰ˆæœ¬å·æ–‡ä»¶å
              mv temp_bin/sing-box* bin/sing-box
          fi
          rm -rf temp_bin sing-box-android.tar.gz
          chmod +x bin/sing-box

          # 2. æŠ“å–æ¨¡æ¿
          # config.template.json ç°åœ¨ç‰©ç†ä½ç½®åœ¨æ ¹ç›®å½•
          curl -fL -o config.template.json https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/mobile/config.template.json
          # .env.example ä¹Ÿåœ¨æ ¹ç›®å½•
          curl -fL -o .env.example https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/main/.env.example

      - name: Extract Upstream Commit Message
        run: |
          # æ ¸å¿ƒç‚¹ï¼šä»æ¨¡æ¿ä»“åº“æŠ“å–æœ€æ–°çš„ commit message
          UPSTREAM_MSG=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-config-templates/commits/mobile | jq -r '.commit.message')
          echo "UPSTREAM_MSG<<EOF" >> $GITHUB_ENV
          echo "$UPSTREAM_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Prepare Module Versioning
        run: |
          # 1. æå–ç‰ˆæœ¬å· (SSOT)
          DISPLAY_VER=$(grep -m 1 "^## " CHANGELOG.md | sed 's/## //')

          # [æ–°å¢åˆ¤æ–­] å¦‚æœæ˜¯ Dispatch è§¦å‘ï¼Œä¸ºäº†å¼ºåˆ¶è§¦å‘ KSU æ›´æ–°ï¼Œæˆ‘ä»¬è‡ªåŠ¨åœ¨ r åç¼€åé¢åŠ ä¸Š build æ—¶é—´æˆ³
          # è¿™æ ·å³ä¾¿ä½ æ²¡æ”¹æ—¥å¿—ï¼ŒversionCode ä¹Ÿä¼šå˜ï¼Œç”¨æˆ·èƒ½æ”¶åˆ°â€œé…ç½®æ›´æ–°â€
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
             DISPLAY_VER="${DISPLAY_VER}-cfg$(date +%H%M)"
          fi

          echo "DISPLAY_VER=$DISPLAY_VER" >> $GITHUB_ENV

          # 2. è®¡ç®— V_CODE (æå– -r åçš„æ•°å­—)
          MOD_REV=$(echo "$DISPLAY_VER" | sed 's/.*-r//')
          V_CODE=$(date +%Y%m%d)$MOD_REV

          # 3. æ³¨å…¥æ¨¡æ¿ (ä¸è§¦ç¢°å…¶ä»–ä»»ä½•è¡Œ)
          sed -i "s/\${DISPLAY_VER}/$DISPLAY_VER/" module.prop
          sed -i "s/\${V_CODE}/$V_CODE/" module.prop

          # [ä¿®å¤] åªæœ‰åœ¨é Dispatch äº‹ä»¶æ—¶ï¼Œæ‰å»åˆ‡ CHANGELOG
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
              echo "### ğŸš€ ä¸Šæ¸¸é…ç½®å˜æ›´" > release_body.txt
              echo "${{ env.UPSTREAM_MSG }}" >> release_body.txt
          else
              # 4. æå–å½“å‰ç‰ˆæœ¬çš„ Changelog ç”¨äº GitHub Release é¡µé¢
              VERSION_ESCAPED=$(echo "$DISPLAY_VER" | sed 's/\./\\./g')
              sed -n "/## $VERSION_ESCAPED/,/## /p" CHANGELOG.md | sed '$d' > release_body.txt
          fi
      - name: Create Module Package
        run: |
          # 1. ç‰©ç†é”æ­»å¸¦ç‰ˆæœ¬å·çš„æ–‡ä»¶å
          ZIP_NAME="sing-box-ksu-module-${{ env.DISPLAY_VER }}.zip"

          # 2. æ‰“åŒ… (ä¿æŒ -ry è½¯é“¾æŒ‡é’ˆ)
          zip -ry "$ZIP_NAME" bin etc system customize.sh service.sh module.prop update.json LICENSE CHANGELOG.md README.md .env.example config.template.json

          # 3. ä¼ å¯¼è·¯å¾„ç»™ Release æ­¥éª¤
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Release Module
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.DISPLAY_VER }}
          name: Sing-box for KSU [${{ env.DISPLAY_VER }}]
          body_path: release_body.txt
          files: ${{ env.ZIP_PATH }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Backfill Update Info
        if: github.event_name != 'pull_request'
        run: |
          # æ›´æ–° update.json å¹¶å›å†™åˆ°ä»“åº“
          jq ".version = \"${{ env.DISPLAY_VER }}\" | .versionCode = $(date +%Y%m%d)${{ github.run_number }} | .zipUrl = \"https://github.com/${{ github.repository }}/releases/latest/download/${{ env.ZIP_PATH }}\"" update.json > update.tmp
          mv update.tmp update.json

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add update.json
          # [é˜²çº¿2] åŠ ä¸Š [skip ci] ç¡®ä¿ä¸‡æ— ä¸€å¤±
          git commit -m "chore: auto-update metadata for ${{ env.DISPLAY_VER }} [skip ci]" || exit 0
          git push origin main
