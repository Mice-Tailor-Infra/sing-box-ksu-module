name: Build and Release Module

on:
  workflow_dispatch:
  repository_dispatch:
    types: [config_update] # 接收来自模板仓的信号
  push:
    branches: ["main"]
    paths-ignore:
      - "README.md"
      - ".gitignore"
      - "update.json" # [防线1] 忽略 update.json 的变更触发

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Material
        run: |
          # 1. 抓取稳定二进制
          SB_VER=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases | \
            jq -r 'map(select(.tag_name | contains("alpha") | not) | select(.tag_name | contains("dev") | not)) | .[0].tag_name')

          echo "SB_VER=$SB_VER" >> $GITHUB_ENV

          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases/tags/$SB_VER | \
            jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')

          curl -L -o sing-box-android.tar.gz "$DOWNLOAD_URL"

          # [关键修改] 不要解压覆盖整个 bin，而是只提取 sing-box
          # tar -xzf ... -C bin/ 会把 bin 里的 sbc/envsubst 覆盖掉（如果 tar 包里也有同名目录）
          # 虽然你的 tar 包里只有 sing-box，但最稳妥的是解压到临时目录再 mv
          mkdir -p temp_bin
          tar -xzf sing-box-android.tar.gz -C temp_bin/

          # 移动并处理同名冲突 (Mice 专属逻辑)
          if [ -f "temp_bin/bin/sing-box" ]; then
              mv temp_bin/bin/sing-box bin/sing-box
          elif [ -f "temp_bin/sing-box" ]; then
              mv temp_bin/sing-box bin/sing-box
          else
              # 兜底：处理可能的带版本号文件名
              mv temp_bin/sing-box* bin/sing-box
          fi
          rm -rf temp_bin sing-box-android.tar.gz
          chmod +x bin/sing-box

          # 2. 抓取模板
          # config.template.json 现在物理位置在根目录
          curl -fL -o config.template.json https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/mobile/config.template.json
          # .env.example 也在根目录
          curl -fL -o .env.example https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/main/.env.example

      - name: Extract Upstream Commit Message
        run: |
          # 核心点：从模板仓库抓取最新的 commit message
          UPSTREAM_MSG=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-config-templates/commits/mobile | jq -r '.commit.message')
          echo "UPSTREAM_MSG<<EOF" >> $GITHUB_ENV
          echo "$UPSTREAM_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Prepare Module Versioning
        run: |
          # 1. 提取版本号 (SSOT)
          DISPLAY_VER=$(grep -m 1 "^## " CHANGELOG.md | sed 's/## //')

          # [新增判断] 如果是 Dispatch 触发，为了强制触发 KSU 更新，我们自动在 r 后缀后面加上 build 时间戳
          # 这样即便你没改日志，versionCode 也会变，用户能收到“配置更新”
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
             DISPLAY_VER="${DISPLAY_VER}-cfg$(date +%H%M)"
          fi

          echo "DISPLAY_VER=$DISPLAY_VER" >> $GITHUB_ENV

          # 2. 计算 V_CODE (提取 -r 后的数字)
          MOD_REV=$(echo "$DISPLAY_VER" | sed 's/.*-r//')
          V_CODE=$(date +%Y%m%d)$MOD_REV

          # 3. 注入模板 (不触碰其他任何行)
          sed -i "s/\${DISPLAY_VER}/$DISPLAY_VER/" module.prop
          sed -i "s/\${V_CODE}/$V_CODE/" module.prop

          # 4. 提取当前版本的 Changelog 用于 GitHub Release 页面
          VERSION_ESCAPED=$(echo "$DISPLAY_VER" | sed 's/\./\\./g')
          sed -n "/## $VERSION_ESCAPED/,/## /p" CHANGELOG.md | sed '$d' > release_body.txt
      - name: Create Module Package
        run: |
          # 1. 物理锁死带版本号的文件名
          ZIP_NAME="sing-box-ksu-module-${{ env.DISPLAY_VER }}.zip"

          # 2. 打包 (保持 -ry 软链指针)
          zip -ry "$ZIP_NAME" bin etc system customize.sh service.sh module.prop update.json LICENSE CHANGELOG.md README.md .env.example config.template.json

          # 3. 传导路径给 Release 步骤
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Release Module
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.DISPLAY_VER }}
          name: Sing-box for KSU [${{ env.DISPLAY_VER }}]
          body_path: release_body.txt
          files: ${{ env.ZIP_PATH }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Backfill Update Info
        if: github.event_name != 'pull_request'
        run: |
          # 更新 update.json 并回写到仓库
          jq ".version = \"${{ env.DISPLAY_VER }}\" | .versionCode = $(date +%Y%m%d)${{ github.run_number }} | .zipUrl = \"https://github.com/${{ github.repository }}/releases/latest/download/${{ env.ZIP_PATH }}\"" update.json > update.tmp
          mv update.tmp update.json

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add update.json
          # [防线2] 加上 [skip ci] 确保万无一失
          git commit -m "chore: auto-update metadata for ${{ env.DISPLAY_VER }} [skip ci]" || exit 0
          git push origin main
