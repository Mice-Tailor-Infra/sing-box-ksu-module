name: Build Core Module
on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths: ["bin/**", "service.sh", "customize.sh", "module.prop"]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch Latest Core
        run: |
          SB_VER=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases | jq -r 'map(select(.tag_name | contains("alpha") | not)) | .[0].tag_name')
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases/tags/$SB_VER | jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')
          curl -L -o sb.tar.gz "$DOWNLOAD_URL"
          tar -xzf sb.tar.gz -C bin/ --strip-components=1 sing-box || tar -xzf sb.tar.gz -C bin/ sing-box
          chmod +x bin/sing-box

      - name: Prepare Module Metadata
        run: |
          BASE_VER=$(grep -m 1 "^## " CHANGELOG.md | sed 's/## //')
          # 版本号只保留基础版，不带 cfg 碎屑
          V_CODE=$(date +%Y%m%d%H)
          sed -i "s/\${DISPLAY_VER}/$BASE_VER/" module.prop
          sed -i "s/\${V_CODE}/$V_CODE/" module.prop
          echo "VERSION=$BASE_VER" >> $GITHUB_ENV

      - name: Pack and Release
        run: |
          ZIP_NAME="sing-box-ksu-module-${{ env.VERSION }}.zip"
          zip -ry "$ZIP_NAME" bin system customize.sh service.sh module.prop LICENSE CHANGELOG.md README.md .env.example
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          files: ${{ env.ZIP_PATH }}
          generate_release_notes: true

      - name: Update OTA Metadata
        run: |
          jq ".version = \"${{ env.VERSION }}\" | .versionCode = $(date +%Y%m%d%H) | .zipUrl = \"https://github.com/${{ github.repository }}/releases/latest/download/${{ env.ZIP_PATH }}\"" update.json > tmp.json && mv tmp.json update.json
          git config --global user.name "github-actions[bot]"
          git config --global user.email "actions@github.com"
          git add update.json && git commit -m "chore: release ${{ env.VERSION }} [skip ci]" && git push