name: Build and Release Module

on:
  workflow_dispatch:
  repository_dispatch:
    types: [config_update] # æ¥æ”¶æ¥è‡ªæ¨¡æ¿ä»“çš„ä¿¡å·
  push:
    branches: ["main"]
    paths-ignore:
      - "README.md"
      - ".gitignore"
      - "update.json"
      - "_config.yml"
      - "LICENSE"
      # æ³¨æ„ï¼šè¿™é‡Œä¸èƒ½ ignore CHANGELOG.mdï¼Œå› ä¸ºæˆ‘ä»¬è¦å›å†™å®ƒ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch Material
        run: |
          # 1. æŠ“å–ç¨³å®šäºŒè¿›åˆ¶
          SB_VER=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases | \
            jq -r 'map(select(.tag_name | contains("alpha") | not) | select(.tag_name | contains("dev") | not)) | .[0].tag_name')

          echo "SB_VER=$SB_VER" >> $GITHUB_ENV

          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-auto-build-ci/releases/tags/$SB_VER | \
            jq -r '.assets[] | select(.name | contains("android-arm64")) | .browser_download_url')

          curl -L -o sing-box-android.tar.gz "$DOWNLOAD_URL"

          # [å…³é”®ä¿®æ”¹] ä¸è¦è§£å‹è¦†ç›–æ•´ä¸ª binï¼Œè€Œæ˜¯åªæå– sing-box
          # tar -xzf ... -C bin/ ä¼šæŠŠ bin é‡Œçš„ sbc/envsubst è¦†ç›–æ‰ï¼ˆå¦‚æœ tar åŒ…é‡Œä¹Ÿæœ‰åŒåç›®å½•ï¼‰
          # è™½ç„¶ä½ çš„ tar åŒ…é‡Œåªæœ‰ sing-boxï¼Œä½†æœ€ç¨³å¦¥çš„æ˜¯è§£å‹åˆ°ä¸´æ—¶ç›®å½•å† mv
          mkdir -p temp_bin
          tar -xzf sing-box-android.tar.gz -C temp_bin/

          # ç§»åŠ¨å¹¶å¤„ç†åŒåå†²çª (Mice ä¸“å±é€»è¾‘)
          if [ -f "temp_bin/bin/sing-box" ]; then
              mv temp_bin/bin/sing-box bin/sing-box
          elif [ -f "temp_bin/sing-box" ]; then
              mv temp_bin/sing-box bin/sing-box
          else
              # å…œåº•ï¼šå¤„ç†å¯èƒ½çš„å¸¦ç‰ˆæœ¬å·æ–‡ä»¶å
              mv temp_bin/sing-box* bin/sing-box
          fi
          rm -rf temp_bin sing-box-android.tar.gz
          chmod +x bin/sing-box

          # 2. æŠ“å–æ¨¡æ¿
          # config.template.json ç°åœ¨ç‰©ç†ä½ç½®åœ¨æ ¹ç›®å½•
          curl -fL -o config.template.json https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/mobile/config.template.json
          # .env.example ä¹Ÿåœ¨æ ¹ç›®å½•
          curl -fL -o .env.example https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/main/.env.example

      - name: Extract Upstream Commit Message
        run: |
          # æ ¸å¿ƒç‚¹ï¼šä»æ¨¡æ¿ä»“åº“æŠ“å–æœ€æ–°çš„ commit message
          UPSTREAM_MSG=$(curl -s https://api.github.com/repos/cagedbird043/sing-box-config-templates/commits/mobile | jq -r '.commit.message')
          echo "UPSTREAM_MSG<<EOF" >> $GITHUB_ENV
          echo "$UPSTREAM_MSG" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Prepare Module Versioning
        run: |
          # 1. æå–åŸå§‹ç‰ˆæœ¬å·
          RAW_VER=$(grep -m 1 "^## " CHANGELOG.md | sed 's/## //')

          # ã€æ ¸å¿ƒä¿®å¤ã€‘å¼ºåˆ¶å‰¥ç¦»æ—§çš„ cfg åç¼€ï¼Œé˜²æ­¢å †å 
          # æ— è®ºåŸæ¥æ˜¯ r18 è¿˜æ˜¯ r18-cfg1234ï¼Œå¤„ç†åéƒ½å˜æˆ r18
          BASE_VER=$(echo "$RAW_VER" | sed -E 's/-cfg[0-9]+//g')

          DISPLAY_VER="$BASE_VER"

          # 2. å¦‚æœæ˜¯é…ç½®æ›´æ–°è§¦å‘ï¼Œé‡æ–°æ‰“ä¸Šå•ä¸€çš„ cfg æ ‡ç­¾
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
             DISPLAY_VER="${BASE_VER}-cfg$(date +%H%M)"
          fi

          echo "DISPLAY_VER=$DISPLAY_VER" >> $GITHUB_ENV

          # 3. è®¡ç®— versionCode (ä¿æŒåŸæ ·ï¼Œå®ƒæ˜¯é€’å¢çš„æ²¡é—®é¢˜)
          MOD_REV=$(echo "$BASE_VER" | sed 's/.*-r//')
          CLEAN_REV=$(echo "$MOD_REV" | grep -oE '^[0-9]+' || echo "0")
          V_CODE=$(date +%Y%m%d)${{ github.run_number }}

          # 4. æ³¨å…¥æ¨¡æ¿ (ä¸è§¦ç¢°å…¶ä»–ä»»ä½•è¡Œ)
          sed -i "s/\${DISPLAY_VER}/$DISPLAY_VER/" module.prop
          sed -i "s/\${V_CODE}/$V_CODE/" module.prop

          # 5. ç”Ÿæˆ Release Body
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
              echo "### ğŸš€ ä¸Šæ¸¸é…ç½®å˜æ›´" > release_body.txt
              echo "${{ env.UPSTREAM_MSG }}" >> release_body.txt
          else
              VERSION_ESCAPED=$(echo "$DISPLAY_VER" | sed 's/\./\\./g')
              sed -n "/## $VERSION_ESCAPED/,/## /p" CHANGELOG.md | sed '$d' > release_body.txt
          fi

          # [ä¿®å¤] ä½¿ç”¨ if è¯­å¥æ›¿ä»£ && ç®€å†™ï¼Œé˜²æ­¢å› æ–‡ä»¶éç©ºå¯¼è‡´ exit code 1
          if [ ! -s release_body.txt ]; then
            echo "Build from main branch commit: ${{ github.sha }}" > release_body.txt
          fi

      # [æ–°å¢æ­¥éª¤] è‡ªåŠ¨å‘ CHANGELOG.md å¤´éƒ¨è¿½åŠ æ—¥å¿—
      - name: Update CHANGELOG File
        if: github.event_name == 'repository_dispatch'
        run: |
          # æ„é€ æ–°çš„æ—¥å¿—æ¡ç›®
          # æ ¼å¼ï¼š
          # ## v1.12.14-r16-cfg1034
          # 
          # - ğŸš€ ä¸Šæ¸¸é…ç½®å˜æ›´: feat: xxxx

          NEW_ENTRY="## ${{ env.DISPLAY_VER }}\n\n- ğŸš€ ä¸Šæ¸¸é…ç½®å˜æ›´: ${{ env.UPSTREAM_MSG }}\n"

          # å°†æ–°å†…å®¹å’Œæ—§å†…å®¹æ‹¼æ¥
          echo -e "$NEW_ENTRY" | cat - CHANGELOG.md > temp_changelog.md
          mv temp_changelog.md CHANGELOG.md

          # æ­¤æ—¶ CHANGELOG.md å·²ç»æ›´æ–°ï¼Œåç»­æ‰“åŒ…ä¼šæŠŠæœ€æ–°çš„æ—¥å¿—æ‰“è¿›å»

      - name: Create Package
        run: |
          ZIP_NAME="sing-box-ksu-module-${{ env.DISPLAY_VER }}.zip"
          # è¿™é‡Œçš„ CHANGELOG.md å·²ç»æ˜¯æ›´æ–°è¿‡çš„äº†
          zip -ry "$ZIP_NAME" bin system customize.sh service.sh module.prop LICENSE CHANGELOG.md README.md .env.example config.template.json
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Release Module
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.DISPLAY_VER }}
          name: Sing-box for KSU [${{ env.DISPLAY_VER }}]
          body_path: release_body.txt
          files: ${{ env.ZIP_PATH }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Backfill Update Info
        if: github.event_name != 'pull_request'
        run: |
          # æ›´æ–° update.json å¹¶å›å†™åˆ°ä»“åº“
          jq ".version = \"${{ env.DISPLAY_VER }}\" | .versionCode = $(date +%Y%m%d)${{ github.run_number }} | .zipUrl = \"https://github.com/${{ github.repository }}/releases/latest/download/${{ env.ZIP_PATH }}\"" update.json > update.tmp
          mv update.tmp update.json

          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # [ä¿®æ”¹] åŒæ—¶æ·»åŠ  CHANGELOG.md
          git add update.json CHANGELOG.md

          # æäº¤ (å¸¦ skip ci é˜²æ­¢æ­»å¾ªç¯)
          git commit -m "chore: auto-update metadata for ${{ env.DISPLAY_VER }} [skip ci]" || exit 0
          git push origin main
