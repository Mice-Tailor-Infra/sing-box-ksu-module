#!/system/bin/sh
# Mice System Tools - Sing-box Controller (Professional Edition)

WORKSPACE="/data/adb/sing-box-workspace"
BIN="$WORKSPACE/bin/sing-box"
SERVICE_PATH="/data/adb/modules/sing-box-ksu-module/service.sh"
LOG_FILE="$WORKSPACE/var/log/sing-box.log"
TEMPLATE_URL="https://raw.githubusercontent.com/cagedbird043/sing-box-config-templates/mobile/config.template.json"

case "$1" in
    start)
        if pgrep -f "$BIN" > /dev/null; then
            echo "Sing-box 已经在运行中。"
        else
            echo "正在启动 Sing-box (守护模式)..."
            nohup sh "$SERVICE_PATH" > /dev/null 2>&1 &
            echo "启动指令已发送。"
        fi
        ;;
    stop)
        echo "正在停止 Sing-box..."
        
        # 1. 锁定核心进程
        PID=$(pgrep -f "$BIN")
        
        if [ ! -z "$PID" ]; then
            # 2. 处决父进程 (断绝复活)
            # 必须先杀父进程，否则杀完子进程，父进程会在毫秒级内把它拉起来
            PPID=$(ps -o ppid= -p "$PID" | tr -d ' ')
            
            # 3. 优先杀掉父进程 (service.sh)，切断重试循环
            if [ ! -z "$PPID" ]; then
                # 对父进程脚本，用 -15 或 -9 均可，重点是让它停止循环
                kill -15 "$PPID" >/dev/null 2>&1 || true
            fi
            
            # 3. 优雅处决子进程 (触发原生清理)
            # 这是解决 VoLTE 黑屏的核心：SIGTERM 唤醒 sing-box 的 OnClose 清理
            kill -15 "$PID" >/dev/null 2>&1
            
            # 4. 给予清理窗口期 (Wait Logic)
            echo "等待专业清理..."
            count=0
            while kill -0 "$PID" >/dev/null 2>&1; do
                sleep 1
                count=$((count + 1))
                # 给他 10 秒时间清理，如果卡死才强制杀
                if [ $count -gt 10 ]; then
                    echo "⚠️ 进程未响应清理信号，执行强制击杀..."
                    kill -9 "$PID" >/dev/null 2>&1 || true
                    break
                fi
            done
        fi
        
        # 补刀：防止有多个 service.sh 实例
        pkill -15 -f "$SERVICE_PATH" >/dev/null 2>&1 || true
        
        echo "✅ 服务已停止 (Native Cleanup)。"
        ;;
    restart)
        $0 stop
        sleep 1
        $0 start
        ;;
    update)
        echo "正在从云端同步配置模板..."
        TEMP_TMPL="$WORKSPACE/config.template.json.tmp"
        if curl -fL -o "$TEMP_TMPL" "$TEMPLATE_URL"; then
            if grep -q "{" "$TEMP_TMPL"; then
                mv -f "$TEMP_TMPL" "$WORKSPACE/config.template.json"
                chmod 644 "$WORKSPACE/config.template.json"
                echo "✅ 模板同步成功！执行重启以应用更改..."
                $0 restart
            else
                echo "❌ 错误：抓取到的文件内容异常。"
                rm -f "$TEMP_TMPL"
            fi
        else
            echo "❌ 错误：无法连接到 GitHub Raw，请检查网络。"
        fi
        ;;
    status)
        if pgrep -f "$BIN" > /dev/null; then
            PID=$(pgrep -f "$BIN")
            echo "状态: 正在运行 (PID: $PID)"
            echo "工作空间: $WORKSPACE"
            echo "日志最后 5 行:"
            tail -n 5 "$LOG_FILE"
        else
            echo "状态: 已停止"
        fi
        ;;
    *)
        echo "用法: sbc {start|stop|restart|status|update}"
        exit 1
        ;;
esac